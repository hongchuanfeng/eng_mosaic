<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link id="favicon" rel="icon" type="image/png" href="favicon.ico">
    <title>Online free image mosaic - Free Image Mosaic Tool</title>
    <meta name="keywords" content="online free image mosaic, mosaic tool, pixelate image, mosaic editor, privacy blur, pixel art" />
    <meta name="description" content="Online free image mosaic tool to pixelate images, support full mosaic, rectangle area and brush, download in one click." />
    <link rel="canonical" href="https://mosaic.chdaoai.com/">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V0YFLKRH7D"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-V0YFLKRH7D');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7274710287377352"
     crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css.css">
    <style>
        /* 页面长度适当加长 */
        body { min-height: 120vh; }
        .main-div { padding-bottom: 48px; }
        /* 基础布局 */
        .navbar { position: relative; z-index: auto; }
        .nav-container { display: flex; align-items: center; justify-content: space-between; }
        .nav-menu { display: flex; flex-wrap: wrap; gap: 8px; }
        .nav-link { padding: 0; display: inline-flex; align-items: center; }
        .nav-ico { display: inline-block; margin-right: 0; font-size: 16px; line-height: 1; }
        .nav-toggle { display: none; background: transparent; border: none; padding: 8px; cursor: pointer; }
        .hamburger { display: block; width: 22px; height: 2px; background: #333; margin: 5px 0; transition: transform .25s ease, opacity .25s ease; }
        .nav-overlay { display: none; }

        /* PC端 nav-link 间距 */
        @media (min-width: 769px) {
            .nav-link { padding: 5px 0; }
        }

        /* 桌面端加宽版面，避免导航拥挤 */
        @media (min-width: 1025px) {
            html, body { min-width: 1600px; }
            .header-div, .main-div, .navbar, .nav-container { max-width: none; }
        }

        /* Language switch (CN) */
        .lang-switch {
            position: relative; z-index: 2;
            text-decoration: none; user-select: none;
            display: inline-flex; align-items: center;
            height: 36px; border-radius: 18px; overflow: hidden;
            background: linear-gradient(135deg, #6d66ff 0%, #7b6cff 50%, #8a6bff 100%);
            box-shadow: 0 8px 22px rgba(109,102,255,.35);
            color: #fff; margin-left: 12px;
        }
        .lang-switch .ls-left {
            display: inline-flex; align-items: center; padding: 0 14px; gap: 10px;
            background: radial-gradient(120% 120% at 10% 10%, rgba(255,255,255,.16) 0%, rgba(255,255,255,.06) 60%, rgba(255,255,255,0) 100%);
            height: 100%;
        }
        .lang-switch .badge {
            background: rgba(255,255,255,.25);
            padding: 4px 8px; border-radius: 8px; font-weight: 700; letter-spacing: .5px; font-size: 10px;
        }
        .lang-switch .divider { width: 1px; height: 18px; background: rgba(255,255,255,.7); }
        .lang-switch .label { font-size: 10px; font-weight: 600; }
        .lang-switch .ls-right { display: inline-flex; align-items: center; justify-content: center; width: 42px; height: 100%; background: rgba(0,0,0,.14); }
        .lang-switch .arrow { display: inline-block; width: 8px; height: 8px; border-right: 2px solid #fff; border-top: 2px solid #fff; transform: rotate(45deg); }
        .lang-switch:hover { filter: brightness(1.06); }
        .lang-switch:active { transform: translateY(1px); }
        @media (max-width: 768px) {
            /* Keep switch visible above the slide-out drawer */
            .lang-switch { position: fixed; right: 12px; top: 5px; height: 34px; z-index: 10002; }
        }

        /* 移动端抽屉菜单 */
        @media (max-width: 768px) {
            /* 避免父级裁剪或创建新定位上下文导致抽屉被截断 */
            .header-div, .navbar, .nav-container { overflow: visible !important; }
            .header-div, .navbar, .nav-container { transform: none !important; -webkit-transform: none !important; }
            .header-div, .navbar, .nav-container { contain: unset !important; }
            .nav-toggle { display: inline-block; }
            .nav-menu {
                position: fixed; top: 0; bottom: 0; left: 0; width: 85%; max-width: 420px;
                background: #fff; box-shadow: 2px 0 10px rgba(0,0,0,.12);
                display: block; padding: calc(env(safe-area-inset-top,0) + 12px) 12px 24px; overflow-y: auto; -webkit-overflow-scrolling: touch;
                transform: translateX(-100%); transition: transform .25s ease; z-index: 10001; will-change: transform;
            }
            .nav-menu .nav-link { display: flex; align-items: center; padding: 0; border-bottom: 1px solid #f2f2f2; }
            .nav-menu.nav-menu-active { transform: translateX(0); }

            .nav-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.4); opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 10000; display: block; }
            .nav-overlay.nav-overlay-active { opacity: 1; pointer-events: auto; }

            /* 汉堡动画 */
            .nav-toggle.nav-toggle-active .hamburger:nth-child(1) { transform: translateY(7px) rotate(45deg); }
            .nav-toggle.nav-toggle-active .hamburger:nth-child(2) { opacity: 0; }
            .nav-toggle.nav-toggle-active .hamburger:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }
            /* 移动端上下间隙（PC 端不生效） */
            .nav-menu .nav-link { margin: 10px 0; }
        }

        /* Normalize action buttons height and appearance */
        .file-label, #removeMosaicBtn {
            display: inline-flex; align-items: center; justify-content: center;
            height: 44px; padding: 0 20px; line-height: 1; box-sizing: border-box;
            border: none; appearance: none; -webkit-appearance: none; cursor: pointer;
            border-radius: 8px;
        }
    </style>

</head>
<body>
    <header class="header-div">
        <nav class="navbar">
            <div class="nav-container">
                <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation menu">
                    <span class="hamburger"></span>
                    <span class="hamburger"></span>
                    <span class="hamburger"></span>
                </button>
                <div class="nav-menu" id="navMenu">
                    <a href="crop/crop.html" class="nav-link">Crop</a>
                    <a href="convert/convert.html" class="nav-link">Convert</a>
                    <a href="icon/icon.html" class="nav-link">Icon</a>
                    <a href="compress/compress.html" class="nav-link">Compress</a>
                    <a href="blank/blank.html" class="nav-link">B&W</a>
                    <a href="watermark/watermark.html" class="nav-link">Add WMK‌</a>
                    <a href="removewm/removewm.html" class="nav-link">Remove WMK‌</a>
                    <a href="nine/nine.html" class="nav-link">3x3 Grid</a>
                    <a href="text/text.html" class="nav-link">Text2Img</a>
                    <a href="join/join.html" class="nav-link">Stitching</a>
                    <a href="textToimage/textToimage.html" class="nav-link">Add Text2Img</a>
                    <a href="corner/corner.html" class="nav-link">RC</a>
                    <a href="expand/expand.html" class="nav-link">Upscale</a>
                    <a href="old/old.html" class="nav-link">OPR‌</a>
                    <a href="bg/bg.html" class="nav-link">Colorize B/W</a>
                    <a href="removebg/removebg.html" class="nav-link">Remover BG</a>
                    <a href="changebg/changebg.html" class="nav-link">BG Changer</a>
                </div>
                <a class="lang-switch" href="https://mosaic.openai2025.com/" rel="nofollow" aria-label="Switch to Chinese version">
                    <span class="ls-left">
                        <span class="badge">CN</span>
                        <span class="divider"></span>
                        <span class="label">中文</span>
                    </span>
                    <span class="ls-right"><i class="arrow"></i></span>
                </a>
            </div>
        </nav>
        <h1 class="header-title">Image Mosaic</h1>
    </header>

    <!-- 移动端菜单遮罩层 -->
    <div class="nav-overlay" id="navOverlay"></div>

    <main class="main-div">
        <section class="frame-div upload-section">
            <div class="frame-top">
                <label for="fileBtn" class="file-label">Choose Image</label>
                <input type="file" id="fileBtn" accept="image/jpeg,image/gif,image/png,image/bmp,image/webp" />
                <button type="button" id="removeMosaicBtn" class="file-label" style="margin-left:8px;">Remove Mosaic</button>
            </div>
            <div class="frame-center" id="leftFrameCenter" style="position:relative">
                <img id="img" alt="Original image" style="display:none"/>
                <canvas id="overlayCanvas" style="display:none;position:absolute;left:0;top:0;pointer-events:auto"></canvas>
                <div class="placeholder-text">Please select an image</div>
            </div>
        </section>
        <section class="frame-div result-section">
            <div class="frame-top">
                <div class="controls-group">
                    <label for="rangeInput" class="range-label">Mosaic strength: <span id="rangeValue">5</span></label>
                    <input type="range" id="rangeInput" min="1" max="10" value="5" />
                </div>
                <div class="controls-group">
                    <label for="modeSelect" class="range-label">Mode:</label>
                    <select id="modeSelect">
                        <option value="full">Full mosaic</option>
                        <option value="rect">Rectangle area</option>
                        <option value="brush">Brush</option>
                    </select>
                </div>
                <div class="controls-group" id="brushGroup" style="display:none">
                    <label for="brushSize" class="range-label">Brush size: <span id="brushValue">30</span></label>
                    <input type="range" id="brushSize" min="5" max="200" value="30" />
                    <button type="button" id="clearMaskBtn" class="download-btn" style="margin-left:8px">Clear selection</button>
                </div>
                <button type="button" id="downloadBtn" class="download-btn">Download image</button>
            </div>
            <div class="frame-center">
                <img id="convertImg" alt="Processed image" style="display:none"/>
                <div class="placeholder-text">The processed image will appear here</div>
            </div>
        </section>
    </main>
    <div style="max-width:1000px;margin:12px auto 0;color:#666;font-size:14px;line-height:1.6;padding:0 12px;text-align:left;">
        <div><b>Rectangle mode instructions:</b></div>
        <div>1. Choose "Rectangle area" under "Mode" on the right.</div>
        <div>2. Press and drag on the left image to select the area to mosaic, release to apply.</div>
        <div>3. You can add multiple rectangles; to clear, switch to "Brush" mode and click "Clear selection".</div>
    </div>
    <script type="text/javascript">

        var pix = 5;
        // 模式与掩膜状态
        var mode = 'full'; // full | rect | brush
        var brushSize = 30;
        var rectSelecting = false;
        var rectStart = null;
        var maskCanvas = null; // 与原图同像素尺寸

        // 导航菜单切换功能
        document.addEventListener('DOMContentLoaded', function() {
            const navToggle = document.getElementById('navToggle');
            const navMenu = document.getElementById('navMenu');
            const navOverlay = document.getElementById('navOverlay');
            const navOriginalContainer = navMenu ? navMenu.parentElement : null;
            
            // 检查是否为移动端
            function isMobile() {
                return window.innerWidth <= 768;
            }
            
            function toggleMenu() {
                if (isMobile()) {
                    console.log('Toggle menu clicked');
                    navMenu.classList.toggle('nav-menu-active');
                    navToggle.classList.toggle('nav-toggle-active');
                    navOverlay.classList.toggle('nav-overlay-active');
                    
                    // 确保菜单显示时移除隐藏的transform
                    if (navMenu.classList.contains('nav-menu-active')) {
                        navMenu.style.transform = 'translateX(0)';
                        // 禁用页面滚动
                        document.body.classList.add('menu-open');
                        document.documentElement.classList.add('menu-open');
                        
                        // 强制设置菜单滚动属性
                        navMenu.style.overflowY = 'scroll';
                        navMenu.style.overflowX = 'hidden';
                        navMenu.style.height = '100vh';
                        navMenu.style.touchAction = 'pan-y';
                        navMenu.style.webkitOverflowScrolling = 'touch';
                        
                        // 诊断：统计子项高度总和
                        const links = navMenu.querySelectorAll('.nav-link');
                        let totalItemsHeight = 0;
                        links.forEach(el => { totalItemsHeight += el.offsetHeight; });
                        console.log('Menu opened with scroll enabled');
                        console.log('Menu height:', navMenu.clientHeight, 'Content height:', navMenu.scrollHeight, 'Items sum:', totalItemsHeight, 'Count:', links.length);
                        console.log('Menu computed overflow-y:', getComputedStyle(navMenu).overflowY);

                        // 强制添加spacer确保可滚动
                        let spacer = document.getElementById('__nav_spacer__');
                        if (spacer && spacer.parentElement === navMenu) {
                            navMenu.removeChild(spacer);
                        }
                        spacer = document.createElement('div');
                        spacer.id = '__nav_spacer__';
                        spacer.style.height = '300px';
                        spacer.style.width = '100%';
                        spacer.style.display = 'block';
                        spacer.style.pointerEvents = 'none';
                        spacer.style.backgroundColor = 'transparent';
                        spacer.style.flexShrink = '0';
                        navMenu.appendChild(spacer);
                        
                        // 强制重新计算布局
                        navMenu.offsetHeight;
                        
                        // 再次输出高度以验证
                        setTimeout(function(){
                            console.log('After spacer -> Menu height:', navMenu.clientHeight, 'Content height:', navMenu.scrollHeight);
                            console.log('Spacer height:', spacer.offsetHeight);
                            console.log('Can scroll:', navMenu.scrollHeight > navMenu.clientHeight);
                            console.log('Scroll top:', navMenu.scrollTop, 'Max scroll:', navMenu.scrollHeight - navMenu.clientHeight);
                        }, 50);
                    } else {
                        navMenu.style.transform = 'translateX(-100%)';
                        // 恢复页面滚动
                        document.body.classList.remove('menu-open');
                        document.documentElement.classList.remove('menu-open');
                        // 清理占位
                        const spacer = document.getElementById('__nav_spacer__');
                        if (spacer && spacer.parentElement === navMenu) {
                            navMenu.removeChild(spacer);
                        }
                    }
                    
                    console.log('Menu classes:', navMenu.className);
                }
            }
            
            function closeMenu() {
                if (isMobile()) {
                    navMenu.classList.remove('nav-menu-active');
                    navToggle.classList.remove('nav-toggle-active');
                    navOverlay.classList.remove('nav-overlay-active');
                    navMenu.style.transform = 'translateX(-100%)';
                    // 恢复页面滚动
                    document.body.classList.remove('menu-open');
                    document.documentElement.classList.remove('menu-open');
                }
            }

            // 将菜单在移动端提到 body 直下，避免任何父级层叠上下文/裁剪影响层级
            function promoteMenuForMobile(){
                if (!navMenu) return;
                if (isMobile()) {
                    if (navMenu.parentElement !== document.body) {
                        document.body.appendChild(navMenu);
                    }
                    // 确保移动端菜单有正确的样式
                    navMenu.style.display = 'flex';
                    navMenu.style.position = 'fixed';
                    navMenu.style.top = '0';
                    navMenu.style.left = '0';
                    navMenu.style.width = '380px';
                    navMenu.style.height = '100vh';
                    navMenu.style.background = '#ffffff';
                    navMenu.style.flexDirection = 'column';
                    navMenu.style.justifyContent = 'flex-start';
                    navMenu.style.alignItems = 'stretch';
                    navMenu.style.padding = '0';
                    navMenu.style.gap = '0';
                    navMenu.style.zIndex = '10001';
                    navMenu.style.boxShadow = '2px 0 10px rgba(0, 0, 0, 0.1)';
                    navMenu.style.overflowY = 'scroll';
                    navMenu.style.overflowX = 'hidden';
                    navMenu.style.webkitOverflowScrolling = 'touch';
                    navMenu.style.touchAction = 'pan-y';
                    navMenu.style.transition = 'transform .25s ease';
                    
                    // 保持菜单的当前显示状态，不强制隐藏
                    if (!navMenu.classList.contains('nav-menu-active')) {
                        navMenu.style.transform = 'translateX(-100%)';
                    } else {
                        navMenu.style.transform = 'translateX(0)';
                    }
                } else {
                    if (navOriginalContainer && navMenu.parentElement !== navOriginalContainer) {
                        navOriginalContainer.appendChild(navMenu);
                    }
                    // 重置PC端样式
                    navMenu.style.display = '';
                    navMenu.style.position = '';
                    navMenu.style.top = '';
                    navMenu.style.left = '';
                    navMenu.style.width = '';
                    navMenu.style.height = '';
                    navMenu.style.background = '';
                    navMenu.style.flexDirection = '';
                    navMenu.style.justifyContent = '';
                    navMenu.style.alignItems = '';
                    navMenu.style.padding = '';
                    navMenu.style.gap = '';
                    navMenu.style.zIndex = '';
                    navMenu.style.boxShadow = '';
                    navMenu.style.overflowY = '';
                    navMenu.style.webkitOverflowScrolling = '';
                    navMenu.style.transform = '';
                    navMenu.style.transition = '';
                }
            }
            promoteMenuForMobile();
            
            // 只在移动端添加事件监听器
            if (navToggle) {
                navToggle.addEventListener('click', toggleMenu);
            }
            
            if (navOverlay) {
                navOverlay.addEventListener('click', closeMenu);
            }
            
            // 点击菜单项后关闭移动端菜单
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                let startX = 0, startY = 0, startT = 0;
                const threshold = 8; // 允许的手指抖动
                function onStart(e){
                    if (!isMobile()) return;
                    const t = e.touches ? e.touches[0] : e;
                    startX = t.clientX; startY = t.clientY; startT = Date.now();
                }
                function onEnd(e){
                    if (!isMobile()) return;
                    const t = e.changedTouches ? e.changedTouches[0] : e;
                    const dx = Math.abs(t.clientX - startX);
                    const dy = Math.abs(t.clientY - startY);
                    const dt = Date.now() - startT;
                    if (dx < threshold && dy < threshold && dt < 1500) {
                        const href = link.getAttribute('href');
                        if (href) {
                            e.preventDefault(); e.stopPropagation();
                            window.location.assign(href);
                        }
                    }
                }
                link.addEventListener('touchstart', onStart, {passive:true, capture:true});
                link.addEventListener('touchend', onEnd, {passive:false, capture:true});
                link.addEventListener('mousedown', onStart, true);
                link.addEventListener('mouseup', onEnd, true);
                // 兜底：点击事件（防止某些环境未触发指针序列）
                link.addEventListener('click', function(e){
                    if (!isMobile()) return;
                    const href = link.getAttribute('href');
                    if (href) { e.preventDefault(); e.stopPropagation(); window.location.assign(href); }
                }, true);
            });
            
            // 窗口大小改变时重新检查
            window.addEventListener('resize', function() {
                if (!isMobile()) {
                    closeMenu();
                } else {
                    // 移动端时只重新初始化样式，不改变菜单显示状态
                    promoteMenuForMobile();
                }
            });
            
            // 页面滚动时也重新检查菜单状态，但不重置菜单显示状态
            window.addEventListener('scroll', function() {
                if (isMobile()) {
                    // 只确保菜单在正确的位置，不改变显示状态
                    if (navMenu.parentElement !== document.body) {
                        document.body.appendChild(navMenu);
                    }
                    // 保持菜单的当前显示状态
                    if (navMenu.classList.contains('nav-menu-active')) {
                        navMenu.style.transform = 'translateX(0)';
                    } else {
                        navMenu.style.transform = 'translateX(-100%)';
                    }
                }
            });
            
            // 添加滚动测试监听器
            if (navMenu) {
                navMenu.addEventListener('scroll', function() {
                    console.log('Menu scrolling detected:', navMenu.scrollTop);
                });
                console.log('Menu initialized with scroll listener');
            }
        });

        document.getElementById("fileBtn").addEventListener("change",function (e){
            if (window.FileReader) {
                var file = e.target.files[0];
                let reader = new FileReader();
                reader.onload = function (event) {
                    var dataURL = event.target.result;
                    var img = document.getElementById("img");
                    var convertImg = document.getElementById("convertImg");
                    var uploadPlaceholder = img.parentElement.querySelector('.placeholder-text');
                    var resultPlaceholder = convertImg.parentElement.querySelector('.placeholder-text');
                    
                    img.src = dataURL;
                    img.style.display = "block";
                    convertImg.style.display = "block";
                    uploadPlaceholder.style.display = "none";
                    resultPlaceholder.style.display = "none";
                    
                    // 确保两个图片的显示尺寸一致
                    img.onload = function() {
                        convertImg.style.width = img.offsetWidth + 'px';
                        convertImg.style.height = img.offsetHeight + 'px';
                        if (typeof window.__syncOverlaySize === 'function') {
                            window.__syncOverlaySize();
                        }
                    };
                };
                reader.readAsDataURL(file);
            } else {
                alert("您的浏览器不支持更改功能");
            }
        });

        document.getElementById("img").addEventListener("load",function (e){
            if (e.target.src) {
                showConvertPic();
            }
        });


        document.getElementById("rangeInput").addEventListener("change", function (e) {
            if (document.getElementById("img").src) {
                pix = parseInt(e.target.value);
                document.getElementById("rangeValue").textContent = pix;
                showConvertPic();
            }
        });

        document.getElementById("downloadBtn").addEventListener("click",function (e){
            var convertImg = document.getElementById("convertImg");
            if(!!convertImg.src){
                download(convertImg.src);
            } else {
                alert("请先上传图片");
            }
        });

        // Remove mosaic processing
        (function(){
            function createDeMosaicPic(img){
                if(!img || !img.naturalWidth) return null;
                var srcW = img.naturalWidth, srcH = img.naturalHeight;
                var scale = 3; // upscale factor to smooth pixel blocks
                // upscale with smoothing
                var up = document.createElement('canvas');
                up.width = srcW * scale; up.height = srcH * scale;
                var uctx = up.getContext('2d');
                uctx.imageSmoothingEnabled = true;
                uctx.imageSmoothingQuality = 'high';
                uctx.drawImage(img, 0, 0, up.width, up.height);
                // downscale back with smoothing
                var down = document.createElement('canvas');
                down.width = srcW; down.height = srcH;
                var dctx = down.getContext('2d');
                dctx.imageSmoothingEnabled = true;
                dctx.imageSmoothingQuality = 'high';
                dctx.drawImage(up, 0, 0, down.width, down.height);
                return down.toDataURL();
            }

            var removeBtn = document.getElementById('removeMosaicBtn');
            if(removeBtn){
                removeBtn.addEventListener('click', function(){
                    var img = document.getElementById('img');
                    var convertImg = document.getElementById('convertImg');
                    if(!img || !img.src){
                        alert('Please upload an image first');
                        return;
                    }
                    var result = createDeMosaicPic(img);
                    if(result){
                        convertImg.src = result;
                        convertImg.style.display = 'block';
                        // match display size with the left image
                        convertImg.style.width = img.style.width || (img.offsetWidth + 'px');
                        convertImg.style.height = img.style.height || (img.offsetHeight + 'px');
                        var resultPlaceholder = convertImg.parentElement.querySelector('.placeholder-text');
                        if(resultPlaceholder){ resultPlaceholder.style.display = 'none'; }
                    }
                });
            }
        })();

        function showConvertPic(){
            var img = document.getElementById("img");
            var convertImg = document.getElementById("convertImg");
            convertImg.src = createRevertPic(img);
            
            // 确保右边图片的显示尺寸与左边图片一致
            convertImg.style.width = img.style.width || img.offsetWidth + 'px';
            convertImg.style.height = img.style.height || img.offsetHeight + 'px';
        }

        function createRevertPic(img){
            var canvas = document.createElement("canvas");
            // 使用图片的原始尺寸，而不是显示尺寸
            canvas.width = img.naturalWidth;   
            canvas.height = img.naturalHeight;
            var ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight);  
            var c = ctx.getImageData(0, 0, img.naturalWidth, img.naturalHeight);
            var height = c.height;
            var width = c.width;
            for(var i = 0; i < height; i+=pix){
                for(var j = 0; j < width; j+=pix){
                    var rAvg = 0;
                    var gAvg = 0;
                    var bAvg = 0;
                    var aAvg = 0;
                    var count = 0;
                    outerFor:for (var iPix = i; iPix < i+pix; iPix++) {
                        for (var jPix = j; jPix < j+pix; jPix++) {
                            if (iPix > height) {
                                break;
                            } else if(jPix>width){
                                break outerFor;
                            }
                            var x = iPix*4*width + 4*jPix;
                            count++;
                            rAvg += c.data[x];
                            gAvg += c.data[x+1];
                            bAvg += c.data[x+2];
                            aAvg += c.data[x+3];
                        }
                        
                    }
                    rAvg /= (count);
                    gAvg /= (count);
                    bAvg /= (count);
                    aAvg /= (count);

                    outerFor:for (var iPix = i; iPix < i+pix; iPix++) {
                        for (var jPix = j; jPix < j+pix; jPix++) {
                            if (iPix > height) {
                                break;
                            } else if(jPix>width){
                                break outerFor;
                            }
                            var x = iPix*4*width + 4*jPix;
                            c.data[x] = rAvg
                            c.data[x+1] = gAvg;
                            c.data[x+2] = bAvg; 
                            c.data[x+3] = aAvg;
                        }
                    }
                }
            }
            ctx.putImageData(c,0,0);
            return canvas.toDataURL();
        }


        function download(src) {
            var $a = document.createElement('a');
            $a.setAttribute("href", src);
            $a.setAttribute("download", "");

            var evObj = document.createEvent('MouseEvents');
            evObj.initMouseEvent('click', true, true, window, 0, 0, 0, 0, 0, false, false, true, false, 0, null);
            $a.dispatchEvent(evObj);
        };

        
        // ========= 覆盖层尺寸同步 =========
        (function(){
            var overlayCanvas = document.getElementById('overlayCanvas');
            if(!overlayCanvas) return;
            function syncOverlaySize(){
                var img = document.getElementById('img');
                if(!img || img.style.display!=="block") return;
                // 同步尺寸
                overlayCanvas.width = img.offsetWidth;
                overlayCanvas.height = img.offsetHeight;
                overlayCanvas.style.width = img.offsetWidth + 'px';
                overlayCanvas.style.height = img.offsetHeight + 'px';
                // 同步位置（相对其定位父容器）
                overlayCanvas.style.left = img.offsetLeft + 'px';
                overlayCanvas.style.top = img.offsetTop + 'px';
            }
            document.getElementById('img').addEventListener('load', function(){
                syncOverlaySize();
            });
            window.addEventListener('resize', function(){
                syncOverlaySize();
            });
            // 暴露到全局以便文件载入回调也可调用
            window.__syncOverlaySize = syncOverlaySize;
        })();

        // ========= 掩膜与缩放 =========
        function ensureMaskCanvas(){
            var img = document.getElementById('img');
            if(!img || !img.naturalWidth) return;
            if(!maskCanvas || maskCanvas.width!==img.naturalWidth || maskCanvas.height!==img.naturalHeight){
                maskCanvas = document.createElement('canvas');
                maskCanvas.width = img.naturalWidth;
                maskCanvas.height = img.naturalHeight;
                var mctx = maskCanvas.getContext('2d');
                mctx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
            }
        }

        function getScale(){
            var img = document.getElementById('img');
            var sx = img.naturalWidth / img.offsetWidth;
            var sy = img.naturalHeight / img.offsetHeight;
            return {sx, sy};
        }

        // ========= 覆盖层交互（矩形与画笔） =========
        (function(){
            var overlayCanvas = document.getElementById('overlayCanvas');
            if(!overlayCanvas) return;
            var octx = overlayCanvas.getContext('2d');
            var isDrawing = false;
            var startPoint = null;

            function drawBrush(x,y){
                // 预览
                octx.fillStyle = 'rgba(255,0,0,0.25)';
                octx.beginPath();
                octx.arc(x,y, brushSize/2, 0, Math.PI*2);
                octx.fill();
                // 掩膜
                ensureMaskCanvas();
                if(!maskCanvas) return;
                var {sx, sy} = getScale();
                var mctx = maskCanvas.getContext('2d');
                mctx.fillStyle = 'rgba(255,255,255,1)';
                mctx.beginPath();
                mctx.arc(x*sx, y*sy, (brushSize/2)*sx, 0, Math.PI*2);
                mctx.fill();
            }

            function drawRectPreview(p1, p2){
                octx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
                octx.fillStyle = 'rgba(255,0,0,0.25)';
                var x = Math.min(p1.x, p2.x);
                var y = Math.min(p1.y, p2.y);
                var w = Math.abs(p1.x - p2.x);
                var h = Math.abs(p1.y - p2.y);
                octx.fillRect(x,y,w,h);
            }

            function commitRect(p1, p2){
                ensureMaskCanvas();
                if(!maskCanvas) return;
                var {sx, sy} = getScale();
                var mx = Math.min(p1.x, p2.x) * sx;
                var my = Math.min(p1.y, p2.y) * sy;
                var mw = Math.abs(p1.x - p2.x) * sx;
                var mh = Math.abs(p1.y - p2.y) * sy;
                var mctx = maskCanvas.getContext('2d');
                mctx.fillStyle = 'rgba(255,255,255,1)';
                mctx.fillRect(mx,my,mw,mh);
            }

            function getPos(e){
                var rect = overlayCanvas.getBoundingClientRect();
                return {x: e.clientX - rect.left, y: e.clientY - rect.top};
            }

            // 鼠标事件
            overlayCanvas.addEventListener('mousedown', function(e){
                if(mode==='full') return;
                isDrawing = true;
                var p = getPos(e);
                if(mode==='brush'){
                    drawBrush(p.x, p.y);
                }else if(mode==='rect'){
                    rectSelecting = true;
                    startPoint = p;
                    drawRectPreview(startPoint, startPoint);
                }
            });
            overlayCanvas.addEventListener('mousemove', function(e){
                if(!isDrawing) return;
                var p = getPos(e);
                if(mode==='brush'){
                    drawBrush(p.x, p.y);
                }else if(mode==='rect' && rectSelecting){
                    drawRectPreview(startPoint, p);
                }
            });
            window.addEventListener('mouseup', function(e){
                if(!isDrawing) return;
                isDrawing = false;
                if(mode==='rect' && rectSelecting){
                    var p = getPos(e);
                    // 不清空掩膜，新的矩形与已有选择叠加
                    commitRect(startPoint, p);
                    rectSelecting = false;
                    // 清理预览
                    octx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
                }
                showConvertPic();
            });

            // 触摸事件
            overlayCanvas.addEventListener('touchstart', function(e){
                if(mode==='full') return;
                var t = e.touches[0];
                var evt = {clientX:t.clientX, clientY:t.clientY};
                isDrawing = true;
                var p = getPos(evt);
                if(mode==='brush'){
                    drawBrush(p.x, p.y);
                }else if(mode==='rect'){
                    rectSelecting = true;
                    startPoint = p;
                    drawRectPreview(startPoint, startPoint);
                }
                e.preventDefault();
            }, {passive:false});
            overlayCanvas.addEventListener('touchmove', function(e){
                if(!isDrawing) return;
                var t = e.touches[0];
                var evt = {clientX:t.clientX, clientY:t.clientY};
                var p = getPos(evt);
                if(mode==='brush'){
                    drawBrush(p.x, p.y);
                }else if(mode==='rect' && rectSelecting){
                    drawRectPreview(startPoint, p);
                }
                e.preventDefault();
            }, {passive:false});
            overlayCanvas.addEventListener('touchend', function(e){
                if(!isDrawing) return;
                isDrawing = false;
                if(mode==='rect' && rectSelecting){
                    rectSelecting = false;
                }
                showConvertPic();
                e.preventDefault();
            }, {passive:false});
        })();

        // ========= 模式与画笔控件 =========
        (function(){
            var modeSelect = document.getElementById('modeSelect');
            var brushInput = document.getElementById('brushSize');
            var brushGroup = document.getElementById('brushGroup');
            var overlayCanvas = document.getElementById('overlayCanvas');
            var clearBtn = document.getElementById('clearMaskBtn');

            if(modeSelect){
                modeSelect.addEventListener('change', function(e){
                    mode = e.target.value;
                    if(mode==='brush'){
                        brushGroup.style.display = 'inline-flex';
                        if(document.getElementById('img').style.display==='block') overlayCanvas.style.display = 'block';
                    }else if(mode==='rect'){
                        brushGroup.style.display = 'none';
                        if(document.getElementById('img').style.display==='block') overlayCanvas.style.display = 'block';
                    }else{
                        brushGroup.style.display = 'none';
                        overlayCanvas.style.display = 'none';
                    }
                    showConvertPic();
                });
            }
            if(brushInput){
                brushInput.addEventListener('input', function(e){
                    brushSize = parseInt(e.target.value,10);
                    document.getElementById('brushValue').textContent = brushSize;
                });
            }
            if(clearBtn){
                clearBtn.addEventListener('click', function(){
                    var octx = overlayCanvas.getContext('2d');
                    octx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
                    if(maskCanvas){
                        var mctx = maskCanvas.getContext('2d');
                        mctx.clearRect(0,0,maskCanvas.width,maskCanvas.height);
                    }
                    showConvertPic();
                });
            }
        })();

        // ========= 覆盖 createRevertPic 以支持掩膜 =========
        (function(){
            var originalCreate = createRevertPic;
            createRevertPic = function(img){
                var canvas = document.createElement("canvas");
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight);
                var c = ctx.getImageData(0, 0, img.naturalWidth, img.naturalHeight);
                var height = c.height;
                var width = c.width;

                var useMask = (mode !== 'full');
                var maskData = null;
                if(useMask){
                    ensureMaskCanvas();
                    if(maskCanvas){
                        var mctx = maskCanvas.getContext('2d');
                        maskData = mctx.getImageData(0,0,maskCanvas.width,maskCanvas.height).data;
                    }
                }

                for(var i = 0; i < height; i+=pix){
                    for(var j = 0; j < width; j+=pix){
                        if(useMask){
                            // 以块中心像素判断是否在掩膜中，命中更稳定
                            var ci = Math.min(i + Math.floor(pix/2), height - 1);
                            var cj = Math.min(j + Math.floor(pix/2), width - 1);
                            var mIndex = (ci*width + cj) * 4;
                            var marked = maskData && maskData[mIndex+3] > 0;
                            if(!marked){
                                continue;
                            }
                        }
                        var rAvg = 0, gAvg = 0, bAvg = 0, aAvg = 0, count = 0;
                        outerFor: for (var iPix = i; iPix < i+pix; iPix++) {
                            for (var jPix = j; jPix < j+pix; jPix++) {
                                if (iPix > height) {
                                    break;
                                } else if(jPix>width){
                                    break outerFor;
                                }
                                var x = iPix*4*width + 4*jPix;
                                count++;
                                rAvg += c.data[x];
                                gAvg += c.data[x+1];
                                bAvg += c.data[x+2];
                                aAvg += c.data[x+3];
                            }
                        }
                        rAvg /= count; gAvg /= count; bAvg /= count; aAvg /= count;
                        outerFor: for (var iPix2 = i; iPix2 < i+pix; iPix2++) {
                            for (var jPix2 = j; jPix2 < j+pix; jPix2++) {
                                if (iPix2 > height) {
                                    break;
                                } else if(jPix2>width){
                                    break outerFor;
                                }
                                var x2 = iPix2*4*width + 4*jPix2;
                                c.data[x2] = rAvg;
                                c.data[x2+1] = gAvg;
                                c.data[x2+2] = bAvg;
                                c.data[x2+3] = aAvg;
                            }
                        }
                    }
                }
                ctx.putImageData(c,0,0);
                return canvas.toDataURL();
            }
        })();

         
    </script>  

</body>
</html>
